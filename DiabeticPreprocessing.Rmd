---
title: "DiabeticPreprocessing"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Importing dataset

We import the dataset and see which variables have missing values
```{r}
#Set working directory to the one with the data in the following way: setwd("YOUR/PATH")  //NOTICE ORIENTATION OF BAR
diabetic_data <- read.csv("diabetic_data.csv", na.strings = c("?"))
names(which(sapply(diabetic_data, anyNA)))
```

First we want to see the % of missings that each variable has

```{r echo=FALSE}
print(paste0("race: ",(sum(is.na(diabetic_data$race))/dim(diabetic_data)[1])*100))
print(paste0("weight: ",(sum(is.na(diabetic_data$weight))/dim(diabetic_data)[1])*100))
print(paste0("payer_code: ",(sum(is.na(diabetic_data$payer_code))/dim(diabetic_data)[1])*100))
print(paste0("medical_specialty: ",(sum(is.na(diabetic_data$medical_specialty))/dim(diabetic_data)[1])*100))
print(paste0("diag_1: ",(sum(is.na(diabetic_data$diag_1))/dim(diabetic_data)[1])*100))
print(paste0("diag_2: ",(sum(is.na(diabetic_data$diag_2))/dim(diabetic_data)[1])*100))
print(paste0("diag_3: ",(sum(is.na(diabetic_data$diag_3))/dim(diabetic_data)[1])*100))
```

The first decision is to work only with individuals whose weight has been recorded. We notice that these NAs might not be random but structural, but nevertheless we choose this scope of work for our study, as a new criteria over our data: "Each individual should have their weight recorded."
```{r}
diabetic_data <- diabetic_data[!is.na(diabetic_data$weight), ]
n<-dim(diabetic_data)[1]
```

Our dataset has been significantly reduced, and now we have `r n` observations. We re-evaluate the missing values once again.
```{r echo=FALSE}
names(which(sapply(diabetic_data, anyNA)))
print(paste0("race: ",(sum(is.na(diabetic_data$race))/dim(diabetic_data)[1])*100))
print(paste0("payer_code: ",(sum(is.na(diabetic_data$payer_code))/dim(diabetic_data)[1])*100))
print(paste0("medical_specialty: ",(sum(is.na(diabetic_data$medical_specialty))/dim(diabetic_data)[1])*100))
print(paste0("diag_2: ",(sum(is.na(diabetic_data$diag_2))/dim(diabetic_data)[1])*100))
print(paste0("diag_3: ",(sum(is.na(diabetic_data$diag_3))/dim(diabetic_data)[1])*100))
```

Our next step is to input missing values and, since those variables with NAs are all categorical, we will create a new factor named <var>_unknown for each one of them, substituting the missing values by it. This will help for computation and visualization procedures.

```{r}
diabetic_data$race <- factor(diabetic_data$race, levels= c(levels(diabetic_data$race),"race_unknown"))
diabetic_data$race[is.na(diabetic_data$race)] <- "race_unknown"

diabetic_data$payer_code <- factor(diabetic_data$payer_code, levels= c(levels(diabetic_data$payer_code),"payer_code_unknown"))
diabetic_data$payer_code[is.na(diabetic_data$payer_code)] <- "payer_code_unknown"

diabetic_data$medical_specialty <- factor(diabetic_data$medical_specialty, levels= c(levels(diabetic_data$medical_specialty),"medical_specialty_unknown"))
diabetic_data$medical_specialty[is.na(diabetic_data$medical_specialty)] <- "medical_specialty_unknown"

diabetic_data$diag_2 <- factor(diabetic_data$diag_2, levels= c(levels(diabetic_data$diag_2),"diag_2_unknown"))
diabetic_data$diag_2[is.na(diabetic_data$diag_2)] <- "diag_2_unknown"

diabetic_data$diag_3 <- factor(diabetic_data$diag_3, levels= c(levels(diabetic_data$diag_3),"diag_3_unknown"))
diabetic_data$diag_3[is.na(diabetic_data$diag_3)] <- "diag_3_unknown"
```

Now we have no NAs (or at least, they have been reskinned). We want to see the levels of our factors:

```{r}
summary(diabetic_data)
```

We notice several things from this last summary. Firstly, we have too many medicines, most of them apparently uninformative for the subset of data we are dealing with. We also have too many factors over diagnostics, and after a look at the meaning of those factors we notice they are not even ordinal and would not be too useful in their current form (too disperse and the factors' semantical relationship is not expressed).

From these observations, we decide that the next steps for modelling our data are the following:
  - Reduce factors over diagnostics, grouping them semantically. That is, instead of using specific diagnostics, we will map them to the general area they are related to, such as circulatory, respiratory etc. For that, we already have a table made by experts of the field.
  - Collapse the drugs variables, droping most of the unsignificant ones. Our criteria has been to maintain insuline and metformine as they are (since they are both important for diabetes and well distributed over the factors) and to group all of the rest into a new variable 'other_meds', which will be binary, with value 'No' if all of the other drugs have 'No' value and 'Yes' otherwise.
  - Rename the variables and factors if they are too long, for the sake of having a cleaner look.


